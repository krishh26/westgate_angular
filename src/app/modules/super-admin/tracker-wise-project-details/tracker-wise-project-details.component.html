<ngx-spinner bdColor="rgba(51,51,51,0.8)" size="medium" color="#fff" type="ball-scale-multiple">
  <p style="font-size: 20px; color: white">Loading...</p>
</ngx-spinner>
<main id="main">
  <section>
    <div class="container-fluid">
              <div class="row align-items-center">
          <div class="col-lg-12 col-xl-12 col-12 mb-3">
            <!-- Project Title Row -->
            <div class="row mb-3">
              <div class="col-12">
                <div class="d-flex align-items-center flex-wrap project-title-container">
                  <h4 class="me-3 mb-0"><strong>Project Title:</strong></h4>
                  <h4 class="mb-0">{{ projectDetails?.projectName }}</h4>
                </div>
              </div>
            </div>

            <!-- Action Buttons Row -->
            <div class="row">
              <div class="col-12">
                <div class="d-flex flex-wrap gap-2 justify-content-start justify-content-md-end action-buttons-container">
                  <a data-bs-toggle="modal" data-bs-target="#ViewStripAdd" class="btn btn-primary btn-sm text-dark">
                    Add Strips
                  </a>
                  <a class="btn btn-primary btn-sm text-dark" style="cursor: pointer"
                    (click)="editProjectDetails(projectDetails?._id)">
                    Edit <i class="bi bi-pencil-fill"></i>
                  </a>
                  <a (click)="deleteProject(projectDetails?._id)" class="btn btn-danger btn-sm">
                    Delete <i class="bi bi-trash3-fill"></i>
                  </a>
                  <a class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#ViewProjectLogs">
                    Logs
                  </a>
                  <a (click)="goBack()" class="btn btn-primary btn-sm text-dark">
                    Back
                  </a>
                  <a data-bs-toggle="modal" data-bs-target="#ViewMandatoryDetails" class="btn btn-primary btn-sm text-dark">
                    Mandatory Details
                  </a>
                  <a (click)="navigateToTaskDetails()" class="btn btn-info btn-sm text-white">
                    Task Details
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

      <div class="col-lg-12 col-xl-12 col-12 mb-12 mt-5 mb-3">
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-2"><strong>BOS ID:</strong></div>
              <div class="col-md-10">{{ projectDetails?.BOSID || "-" }}</div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Publish Date:</strong></div>
              <div class="col-md-10">
                {{
                projectDetails?.publishDate
                ? (projectDetails?.publishDate | date : "dd/MM/yyyy")
                : "-"
                }}
              </div>
            </div>
            <!-- <div class="row">
              <div class="col-md-2"><strong>Category:</strong></div>
              <div class="col-md-10">{{ projectDetails?.category || "-" }}</div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Industry:</strong></div>
              <div class="col-md-10">{{ projectDetails?.industry || "-" }}</div>
            </div> -->
            <div class="row">
              <div class="col-md-2"><strong>Min value (GBP):</strong></div>
              <div class="col-md-10">
                GBP {{ projectDetails?.minValue || "-" }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Max value (GBP):</strong></div>
              <div class="col-md-10">
                GBP {{ projectDetails?.maxValue || "-" }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Website:</strong></div>
              <div class="col-md-10">{{ projectDetails?.website || "-" }}</div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Link to notice:</strong></div>
              <div class="col-md-10">
                <a *ngIf="projectDetails?.link; else noLink" href="{{ projectDetails?.link }}" target="_blank">Link to
                  Notice</a>
                <ng-template #noLink>-</ng-template>
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Created Date:</strong></div>
              <div class="col-md-10">
                {{
                projectDetails?.createdAt
                ? (projectDetails?.createdAt | date : "dd/MM/yyyy")
                : "-"
                }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Due Date & Time:</strong></div>
              <div class="col-md-10">
                <ng-container *ngIf="projectDetails?.dueDate && projectDetails?.bidsubmissiontime; else noDueDateTime">
                  {{ projectDetails?.dueDate | date : "dd/MM/yyyy" }} ,
                  {{ projectDetails?.bidsubmissiontime }}
                </ng-container>
                <ng-template #noDueDateTime>-</ng-template>
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>CPV Codes:</strong></div>
              <div class="col-md-10">{{ projectDetails?.CPVCodes || "-" }}</div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Notice Reference:</strong></div>
              <div class="col-md-10">
                {{ projectDetails?.noticeReference || "-" }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Status:</strong></div>
              <div class="col-md-10">{{ projectDetails?.status || "-" }}</div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Project Type:</strong></div>
              <div class="col-md-10">
                {{ projectDetails?.projectType || "-" }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Mail Id:</strong></div>
              <div class="col-md-10">{{ projectDetails?.mailID || "-" }}</div>
            </div>

            <div class="row">
              <div class="col-md-2"><strong>Client Type:</strong></div>
              <div class="col-md-10">
                {{ projectDetails?.clientType || "-" }}
              </div>
            </div>

            <div class="row">
              <div class="col-md-2"><strong>Client Name:</strong></div>
              <div class="col-md-10">
                {{ projectDetails?.clientName || "-" }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Categorisation:</strong></div>
              <div class="col-md-10">
                {{ projectDetails?.categorisation || "-" }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Contract Start Date:</strong></div>
              <div class="col-md-10">
                {{
                projectDetails?.periodOfContractStart
                ? (projectDetails?.periodOfContractStart | date : "dd/MM/yyyy")
                : "-"
                }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Contract End Date:</strong></div>
              <div class="col-md-10">
                {{
                projectDetails?.periodOfContractEnd
                ? (projectDetails?.periodOfContractEnd | date : "dd/MM/yyyy")
                : "-"
                }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Result Expected:</strong></div>
              <div class="col-md-10">
                {{
                projectDetails?.resultExpected
                ? (projectDetails?.resultExpected | date : "dd/MM/yyyy")
                : "-"
                }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <section class="pageheader bg-dark">
        <div class="container d-flex justify-content-between align-items-center">
          <p class="mb-0"><strong>Project Description</strong></p>
        </div>
      </section>
      <br />

      <p>{{ projectDetails?.description }}</p>

      <section class="pageheader bg-dark">
        <div class="container">
          <p><strong>Login Details</strong></p>
        </div>
      </section>

      <div class="col-lg-12 col-xl-12 col-12 mb-12 mt-5 mb-3">
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-2"><strong>Login ID:</strong></div>
              <div class="col-md-10">{{ projectDetails?.loginID || "-" }}</div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Password:</strong></div>
              <div class="col-md-10">{{ projectDetails?.password || "-" }}</div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Link to portal:</strong></div>
              <div class="col-md-10">
                <a [href]="projectDetails?.linkToPortal" target="_blank" rel="noopener noreferrer">
                  {{ projectDetails?.linkToPortal }}
                </a>
              </div>
            </div>
            <div class="row">
              <div class="col-md-2"><strong>Documents link:</strong></div>
              <div class="col-md-10">
                <a [href]="projectDetails?.documentsLink" target="_blank" rel="noopener noreferrer">
                  {{ projectDetails?.documentsLink }}
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <section class="pageheader bg-dark">
        <div class="container">
          <p><strong>Documents</strong></p>
        </div>
      </section>
      <br />

      <div class="row mb-4">
        <div class="col-lg-6 col-xl-6 col-12 mob-mb1">
          <h5>Client Documents</h5>
          <div class="card">
            <ul class="project-document">
              <li *ngFor="let item of projectDetails?.clientDocument">
                <div class="row">
                  <div class="col-5 text-center">
                    <p class="mb-0">
                      {{ item?.name }}
                    </p>
                  </div>
                  <div class="col-7 text-center">
                    <a href="javascript:void(0);" class="btn btn-primary btn-sm me-2" data-bs-toggle="modal"
                      data-bs-target="#ViewClientDoc" (click)="openDocument(item)">
                      <i class="bi bi-eye-fill"></i> View
                    </a>

                    <a href="javascript:void(0);" (click)="download(item?.file?.url, item?.name)"
                      class="btn btn-primary btn-sm me-2">
                      <i class="bi bi-file-earmark-arrow-down-fill"></i> Download
                    </a>

                    <a href="javascript:void(0);" (click)="deleteDocuments(item?.name, 'clientDocument')"
                      class="btn btn-danger btn-sm">
                      <i class="bi bi-trash-fill"></i> Delete
                    </a>

                  </div>

                </div>
              </li>
            </ul>
            <button data-bs-toggle="modal" data-bs-target="#addClientDocument" type="button"
              class="btn btn-dark btn-sm add-card-btn">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>
        </div>

        <div class="col-lg-6 col-xl-6 col-12 mob-mb1 mb-3">
          <h5>WestGate Documents</h5>
          <div class="card">
            <ul class="project-document">
              <!-- Document List -->
              <li *ngFor="let item of projectDetails?.westGetDocument" class="list-group-item">
                <div class="row">
                  <div class="col-5 text-center">
                    <p class="mb-0">{{ item?.name }}</p>
                  </div>
                  <div class="col-7 text-center">
                    <a href="href:;" class="btn btn-primarysm me-2" data-bs-toggle="modal"
                      data-bs-target="#ViewClientDoc" (click)="openDocument(item)">
                      <i class="bi bi-eye-fill"></i> View
                    </a>
                    <a href="javascript:void(0);" (click)="download(item?.file?.url, item?.name)"
                      class="btn btn-primary btn-sm me-2">
                      <i class="bi bi-file-earmark-arrow-down-fill"></i> Download
                    </a>
                    <a href="javascript:void(0);" (click)="deleteDocuments(item?.name, 'westgateDocument')"
                      class="btn btn-danger btn-sm ">
                      <i class="bi bi-trash-fill"></i> Delete
                    </a>
                  </div>
                </div>
              </li>
            </ul>
            <button data-bs-toggle="modal" data-bs-target="#addWestgateDocument" type="button"
              class="btn btn-dark btn-sm add-card-btn">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="col-lg-12 col-xl-12 col-12 mb-3">
        <div class="card shadow-sm p-4">
          <div class="card-header bg-secondary text-white mb-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              Shortlisted Supplier :
              <span *ngIf="projectDetails?.selectedUserIds?.[0]?.isSelected !== false">
                {{ projectDetails?.selectedUserIds?.[0]?.companyName }}
              </span>
            </h5>
            <div class="d-flex gap-3 align-items-center">
              <ng-container>
                <ng-select style="padding: 0px !important" placeholder="Select Supplier"
                  class="form-select custom-ng-select-option" [items]="allSuppliers" bindLabel="companyName" bindValue="_id"
                  [addTag]="true" [clearable]="false" [multiple]="true" [(ngModel)]="selectedSupplierIds">
                </ng-select>
              </ng-container>
              <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="modal"
                data-bs-target="#supplierModal" *ngIf="selectedSupplierIds && selectedSupplierIds.length > 0">
                Submit
              </button>
              <button class="btn btn-outline-light btn-sm" type="button" (click)="toggleSupplierList()">
                View All
              </button>
            </div>
          </div>

          <!-- Supplier Selection Modal -->
          <div class="modal fade" id="supplierModal" tabindex="-1" aria-labelledby="supplierModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="supplierModalLabel">Add Supplier Reason</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="form-group">
                    <label for="supplierReason" class="form-label">Reason for Selection</label>
                    <textarea class="form-control" id="supplierReason" rows="3" [(ngModel)]="supplierSelectionReason"
                      placeholder="Enter reason for selecting these suppliers"></textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" (click)="saveSupplierSelection()">Save</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Mail Send Clarification Modal for New Reason -->
          <div class="modal fade" id="newReasonMailModal" tabindex="-1" aria-labelledby="newReasonMailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="newReasonMailModalLabel">Mail Send Clarification</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="form-group">
                    <label for="mailConfirmation" class="form-label">Do you want to send mail to the supplier for the new reason?</label>
                    <div class="d-flex gap-2 mt-3">
                      <button type="button" class="btn btn-danger flex-fill" (click)="handleMailSendResponse(false)" data-bs-dismiss="modal">No</button>
                      <button type="button" class="btn btn-success flex-fill" (click)="handleMailSendResponse(true)" data-bs-dismiss="modal">Yes</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Mail Send Clarification Modal for Shortlisted Selection -->
          <div class="modal fade" id="shortlistMailModal" tabindex="-1" aria-labelledby="shortlistMailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="shortlistMailModalLabel">Mail Send Clarification</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="form-group">
                    <label for="mailConfirmation" class="form-label">Do you want to send mail to the shortlisted supplier?</label>
                    <div class="d-flex gap-2 mt-3">
                      <button type="button" class="btn btn-danger flex-fill" (click)="handleSelectMailSendResponse(false)" data-bs-dismiss="modal">No</button>
                      <button type="button" class="btn btn-success flex-fill" (click)="handleSelectMailSendResponse(true)" data-bs-dismiss="modal">Yes</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Mail Send Clarification Modal for Supplier Selection -->
          <div class="modal fade" id="supplierMailModal" tabindex="-1" aria-labelledby="supplierMailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="supplierMailModalLabel">Mail Send Clarification</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="form-group">
                    <label for="mailConfirmation" class="form-label">Do you want to send mail to the selected suppliers?</label>
                    <div class="d-flex gap-2 mt-3">
                      <button type="button" class="btn btn-danger flex-fill" (click)="handleSupplierMailSendResponse(false)" data-bs-dismiss="modal">No</button>
                      <button type="button" class="btn btn-success flex-fill" (click)="handleSupplierMailSendResponse(true)" data-bs-dismiss="modal">Yes</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="showSupplierList" class="mt-3">
            <ul class="list-group">
              <li *ngFor="let supplier of selectedSuppliersList" class="list-group-item d-flex flex-column">
                <div class="d-flex align-items-center w-100 gap-2 mb-2">
                  <span class="flex-grow-1" style="min-width: 150px; text-align: left">{{ supplier?.companyName }}</span>
                  <button class="btn btn-sm btn-primary" style="flex-grow: 0; min-width: 80px"
                    (click)="viewAllComments(supplier._id)" data-bs-toggle="modal" data-bs-target="#viewReasonList">
                    View all
                  </button>
                  <button class="btn btn-sm btn-success" *ngIf="!supplier?.isSelected"
                    style="flex-grow: 0; min-width: 80px" (click)="selectSupplier(supplier)">
                    Select
                  </button>
                  <button class="btn btn-sm btn-danger" *ngIf="supplier?.isSelected"
                    style="flex-grow: 0; min-width: 80px" (click)="deSelectSupplier(supplier)">
                    De-Select
                  </button>
                  <!-- Flag Button for Supplier Status -->
                  <button class="btn btn-sm supplier-status-flag"
                    [ngClass]="getSupplierStatusClass(supplier)"
                    [title]="getSupplierStatusTooltip(supplier)"
                    (click)="toggleSupplierStatus(supplier)"
                    [disabled]="isSupplierStatusDisabled(supplier)"
                    style="flex-grow: 0; min-width: 80px; margin-right: 5px;">
                    <i class="bi" [ngClass]="getSupplierStatusIcon(supplier)"></i>
                    {{ getSupplierStatusText(supplier) }}
                  </button>
                  <button class="btn btn-sm btn-danger" style="flex-grow: 0; min-width: 80px"
                    (click)="removeShortlistSupplier(supplier)">
                    Remove
                  </button>
                </div>
                <!-- Latest Reason Display -->
                <div *ngIf="getLatestReason(supplier._id)" class="mt-1 p-2 bg-light rounded w-100">
                  <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted"><strong>Latest Reason:</strong> {{ getLatestReason(supplier._id)?.comment
                      }}</small>
                    <small class="text-muted">{{ getLatestReason(supplier._id)?.date | date : "dd/MM/yyyy" }}</small>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>

             <!-- Minimal Requirement Card -->
       <div class="card mb-4" *ngIf="minimalRequirementData">
         <div class="card-header d-flex justify-content-between align-items-center">
           <h6 class="mb-0">Mandatory requirements (Minimum eligibility criteria)</h6>
           <div class="d-flex align-items-center gap-2">
             <small class="text-muted">{{ minimalRequirementData?.minimalRequirement?.createdAt | date: 'dd/MM/yyyy hh:mm a' }}</small>
             <button type="button" class="btn btn-danger btn-sm" (click)="deleteMinimalRequirement()">
               <i class="bi bi-trash3-fill"></i>
             </button>
           </div>
         </div>
         <div class="card-body">
           <div class="row">
             <div class="col-12">
               <div class="mb-2" [innerHTML]="minimalRequirementData?.minimalRequirement?.description || '-'"></div>
             </div>
           </div>
         </div>
       </div>

      <section class="pageheader bg-dark mb-3">
        <div class="container d-flex justify-content-between align-items-center">
          <p class="mb-0">
            <strong>Assign Bid User:
              {{projectDetails?.assignBidmanager?.[0]?.name}}</strong>
          </p>
          <p class="mb-0">
            <strong>Due Date:
              {{
              (projectDetails?.assignBidmanager?.[0]?.dueDate | date :
              "dd/MM/yyyy")
              }}</strong>
          </p>
        </div>
      </section>


      <div class="row align-items-end mb-4">
        <div class="col-lg-5 col-md-5 col-sm-12">
          <form autocomplete="off">
            <div class="detail-item">
              <label>Assign To</label>
              <ng-select style="padding: 0px !important" placeholder="Select Assign User"
                class="form-select custom-ng-select-option" bindLabel="userName" bindValue="_id" [items]="BiduserList"
                [(ngModel)]="assignTo" name="assignTo">
              </ng-select>
            </div>
          </form>
        </div>

        <div class="col-lg-5 col-md-5 col-sm-12">
          <div class="detail-item">
            <label>Due Date</label>
            <div class="input-group">
              <input class="form-control" type="date" [(ngModel)]="dueDate" name="dueDate" />
            </div>
          </div>
        </div>

        <div class="col-lg-2 col-md-2 col-sm-12 text-end">
          <button type="button" class="btn btn-primary w-100" (click)="assignUser()">
            Submit
          </button>
        </div>
      </div>



      <div class="row align-items-end mb-4">
        <div class="col-lg-12 col-xl-12 col-12 mb-2">
          <div class="card shadow-sm p-4">
            <!-- Header -->
            <div class="card-header bg-primary text-white mb-3">
              <h5 class="mb-0">Feasibility Status</h5>
            </div>

            <!-- Status Buttons -->
            <div class="d-flex justify-content-between flex-wrap mb-4">
              <button class="btn btn-outline-primary flex-fill m-1" [class.active]="feasibilityStatus === 'InProgress'"
                (click)="statusFeasibilityChange('InProgress')">
                In-Progress
              </button>
              <button class="btn btn-outline-secondary flex-fill m-1" [class.active]="feasibilityStatus === 'InHold'"
                (click)="statusFeasibilityChange('InHold')">
                In-Hold
              </button>
              <button class="btn btn-outline-success flex-fill m-1" [class.active]="feasibilityStatus === 'Passed'"
                (click)="statusFeasibilityChange('Passed')">
                Pass
              </button>
              <button class="btn btn-outline-danger flex-fill m-1" [class.active]="feasibilityStatus === 'Fail'"
                (click)="statusFeasibilityChange('Fail')">
                Fail
              </button>
              <button class="btn btn-outline-warning flex-fill m-1"
                [class.active]="feasibilityStatus === 'DocumentsNotFound'"
                (click)="statusFeasibilityChange('DocumentsNotFound')">
                Document Not Found
              </button>
              <button class="btn btn-outline-dark flex-fill m-1" [class.active]="feasibilityStatus === 'Not Releted'"
                (click)="statusFeasibilityChange('Not Releted')">
                Not Releted
              </button>
            </div>

            <!-- Dynamic Comment Section -->
            <div *ngIf="feasibilityStatus" class="status-section">
              <h6 class="text-secondary mb-3">
                {{ feasibilityStatus }} Comments
              </h6>

              <!-- Display Existing Comments -->
              <div *ngIf="feasibilityCommentData?.length" class="comment-list comments-section">
                <div class="comment-item border rounded p-3 mb-2" *ngFor="let item of feasibilityCommentData">
                  <div class="comment mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                      <p class="mb-0 fw-bold">
                        {{ item?.userDetails?.name }}
                      </p>
                      <small class="text-muted">
                        {{ item?.date | date : "dd/MM/yyyy, h:mm a" }}
                      </small>
                    </div>
                    <small class="text-muted d-block"><strong>Status :</strong> {{ item?.status }}</small>
                    <div class="d-flex justify-content-between">
                      <p class="mt-2" [innerHTML]="item?.comment"></p>
                      <button class="btn btn-sm text-danger" (click)="deleteComment(item, item?.commentId)">
                        Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="comment-list comments-section">
                <div class="comment-item border rounded p-3 mb-2" *ngFor="let reason of getReasonList">
                  <div class="comment mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                      <p class="mb-0 fw-bold">
                        {{ reason?.userDetails?.name }}
                      </p>
                      <small class="text-muted">
                        {{ reason?.date | date : "dd/MM/yyyy, h:mm a" }}
                      </small>
                    </div>
                    <small class="text-muted d-block"><strong>Reason :</strong> {{ reason?.comment }}</small>
                    <div class="d-flex justify-content-between">
                      <p class="mt-2">{{ reason?.tag }}</p>
                      <button class="btn btn-sm text-danger" (click)="deleteFailedReasons(reason, reason?.commentId)">
                        Delete Reason
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Add New Comment -->
              <ng-container>
                <div class="add-comment d-flex gap-3 align-items-center mt-3 mb-2" *ngIf="feasibilityStatus !== 'Fail'">
                  <div class="NgxEditor__Wrapper flex-grow-1">
                    <ngx-editor-menu [editor]="feasibilityEditor" [toolbar]="toolbar">
                    </ngx-editor-menu>
                    <ngx-editor [editor]="feasibilityEditor" [formControl]="feasibilityStatusComment"
                      [placeholder]="'Type here...'" class="ngx-editor-textarea">
                    </ngx-editor>
                  </div>
                  <button class="btn btn-primary" type="button"
                    [disabled]="!feasibilityStatusComment.value || !feasibilityStatus"
                    (click)="pushFeasibilityStatus()">
                    <i class="bi bi-plus-lg"></i> Add
                  </button>
                </div>
              </ng-container>

              <!-- Fail Specific Fields -->
              <ng-container>
                <div *ngIf="feasibilityStatus === 'Fail'" class="mt-4">
                  <div class="d-flex align-items-center gap-3">
                    <select class="form-select" [(ngModel)]="selectedFailReason">
                      <option disabled selected hidden value="">
                        Select Fail Reason
                      </option>
                      <option value="Accreditation">Accreditation</option>
                      <option value="Time Constraints">Time Constraints</option>
                      <option value="Certification">Certification</option>
                      <option value="Case Study">Case Study</option>
                      <option value="Pre-Market">Pre-Market</option>
                      <option value="Certifications from Subcontractor">
                        Certifications from Subcontractor
                      </option>
                      <option value="Delivery of goods/Hardware">
                        Delivery of goods/Hardware
                      </option>
                      <option value="Financial Conditions">
                        Financial Conditions
                      </option>
                      <option value="Not related">Not related</option>
                      <option value="No Subcontracting">
                        No Subcontracting
                      </option>
                      <option value="No Supplier Match">
                        No Supplier Match
                      </option>
                      <option value="Supplier Not Eligible">
                        Supplier Not Eligible
                      </option>
                      <option value="Other">Other</option>
                    </select>
                    <button class="btn btn-outline-primary" type="button" (click)="addFailReason()">
                      <i class="bi bi-plus-lg">Feasibility</i>
                    </button>
                  </div>

                  <!-- Display added reasons and comments -->
                  <div class="mt-3">
                    <div class="reason-item border rounded p-3 mb-2"
                      *ngFor="let reason of failStatusReasons; let i = index">
                      <div class="d-flex align-items-center">
                        <span class="me-3"><strong>Reason:</strong> {{ reason?.tag }}</span>
                        <input type="text" class="form-control me-3" style="flex: 1" placeholder="Add your comment"
                          [(ngModel)]="reason.comment" />
                        <button class="btn btn-sm btn-danger" type="button" (click)="removeFailReason(i)">
                          Remove
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
              <ng-container>
                <div class="row justify-content-end mb-4">
                  <div class="col-lg-2 col-xl-2 col-md-2 col-sm-2 col-12 text-end">
                    <a (click)="saveFeasibilityStatus('save')" [class.disabled]="
                        !isCommentValid() && feasibilityStatus !== 'Fail'
                      " class="btn btn-primary w-100">Save Status</a>
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
        </div>

        <div class="col-lg-12 col-xl-12 col-12" *ngIf="projectDetails?.status == 'Passed'">
          <div class="card shadow-sm p-4">
            <!-- Header -->
            <div class="card-header bg-primary text-white mb-3">
              <h5 class="mb-0">Bid Status</h5>
            </div>

            <!-- Status Buttons -->
            <div class="d-flex justify-content-between flex-wrap mb-4">
              <button class="btn btn-outline-info flex-fill m-1" [class.active]="status === 'Awaiting'"
                (click)="statusChange('Awaiting')">
                Awaiting
              </button>
              <button class="btn btn-outline-primary flex-fill m-1" [class.active]="status === 'Query Raised'"
                (click)="statusChange('Query Raised')">
                Query Raised
              </button>
              <button class="btn btn-outline-info flex-fill m-1" [class.active]="status === 'InSolution'"
                (click)="statusChange('InSolution')">
                In-Solution
              </button>
              <button class="btn btn-outline-secondary flex-fill m-1" [class.active]="status === 'WaitingForResult'"
                (click)="statusChange('WaitingForResult')">
                Waiting For Result
              </button>
              <button class="btn btn-outline-success flex-fill m-1"
                [class.active]="status === 'Dropped after feasibility'"
                (click)="statusChange('Dropped after feasibility')">
                Dropped After Feasibility
              </button>
              <button class="btn btn-outline-danger flex-fill m-1" [class.active]="status === 'Awarded'"
                (click)="statusChange('Awarded')">
                Awarded
              </button>
              <button class="btn btn-outline-warning flex-fill m-1" [class.active]="status === 'NotAwarded'"
                (click)="statusChange('NotAwarded')">
                Not Awarded
              </button>
              <button class="btn btn-outline-dark flex-fill m-1" [class.active]="status === 'Nosuppliermatched'"
                (click)="statusChange('Nosuppliermatched')">
                No Supplier Matched
              </button>
              <button class="btn btn-outline-secondary flex-fill m-1" [class.active]="status === 'Go-NoGoStage1'"
                (click)="statusChange('Go-NoGoStage1')">
                GO-NO GO STAGE 1
              </button>
              <button class="btn btn-outline-danger flex-fill m-1" [class.active]="status === 'SupplierConfirmation'"
                (click)="statusChange('SupplierConfirmation')">
                SUPPLIER CONFIRMATION
              </button>
              <button class="btn btn-outline-success flex-fill m-1" [class.active]="status === 'Go-NoGoStage2'"
                (click)="statusChange('Go-NoGoStage2')">
                GO-NO GO STAGE 2
              </button>

            </div>

            <!-- Dynamic Comment Section -->
            <div *ngIf="status" class="status-section">
              <h6 class="text-secondary mb-3">{{ status }} Comments</h6>

              <!-- Display Existing Comments -->
              <div *ngIf="commentData?.length" class="comment-list comments-section">
                <div class="comment-item border rounded p-3 mb-2" *ngFor="let item of commentData">
                  <div class="comment mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                      <p class="mb-0 fw-bold">
                        {{ item?.userDetails?.name }}
                      </p>
                      <small class="text-muted">
                        {{ item?.date | date : "dd/MM/yyyy, h:mm a" }}
                      </small>
                    </div>
                    <small class="text-muted d-block"><strong>Status :</strong>
                      {{ item?.bidManagerStatus }}</small>
                    <div class="d-flex justify-content-between">
                      <p class="mt-2" [innerHTML]="item?.comment"></p>
                      <button class="btn btn-sm text-danger" (click)="deleteBidComment(item, item?.commentId)">
                        Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="comment-list comments-section">
                <div class="comment-item border rounded p-3 mb-2"
                  *ngFor="let droppedreason of getDroppedAfterReasonList">
                  <div class="comment mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                      <p class="mb-0 fw-bold">
                        {{ droppedreason?.userDetails?.name }}
                      </p>
                      <small class="text-muted">
                        {{ droppedreason?.date | date : "dd/MM/yyyy, h:mm a" }}
                      </small>
                    </div>
                    <small class="text-muted d-block"><strong>Reason :</strong>
                      {{ droppedreason?.comment }}</small>
                    <div class="d-flex justify-content-between">
                      <p class="mt-2">{{ droppedreason?.tag }}</p>
                      <button class="btn btn-sm text-danger" (click)="
                          deleteDroppedReasons(
                            droppedreason,
                            droppedreason?.commentId
                          )
                        ">
                        Delete Reason
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Add New Comment -->
              <ng-container>
                <div class="add-comment d-flex gap-3 align-items-center mt-3 mb-2"
                  *ngIf="status !== 'Dropped after feasibility'">
                  <div class="NgxEditor__Wrapper flex-grow-1">
                    <ngx-editor-menu [editor]="bidStatusEditor" [toolbar]="toolbar">
                    </ngx-editor-menu>
                    <ngx-editor [editor]="bidStatusEditor" [formControl]="bidManagerStatusComment"
                      [placeholder]="'Type here...'" class="ngx-editor-textarea">
                    </ngx-editor>
                  </div>
                  <button class="btn btn-primary" type="button" [disabled]="bidStatusDisable" (click)="pushStatus()">
                    <i class="bi bi-plus-lg"></i> Add
                  </button>
                </div>
              </ng-container>

              <!-- Dropper After Feasibility Specific Fields -->
              <ng-container>
                <div *ngIf="status === 'Dropped after feasibility'" class="mt-4">
                  <div class="d-flex align-items-center gap-3">
                    <select class="form-select" [(ngModel)]="selectedDroppedAfterFeasibilityReason">
                      <option disabled selected hidden value="">
                        Select Dropper After Feasibility
                      </option>
                      <option value="Subcontracting No">
                        Subcontracting No
                      </option>
                      <option value="Supplier Dropped">Supplier Dropped</option>
                      <option value="Time Constrain">Time Constrain</option>
                      <option value="Rejected In Yes/No Call">
                        Rejected In Yes/No Call
                      </option>
                      <option value="Supplier Did Not Meet Eligibility Criteria">
                        Supplier Did Not Meet Eligibility Criteria
                      </option>
                      <option value="Other">Other</option>
                    </select>
                    <button class="btn btn-outline-primary" type="button" (click)="adddroppedReason()">
                      <i class="bi bi-plus-lg">Dropped</i>
                    </button>
                  </div>

                  <!-- Display added bid reasons and comments -->
                  <div class="mt-3">
                    <div class="reason-item border rounded p-3 mb-2"
                      *ngFor="let reason of droppedStatusReasons; let i = index">
                      <div class="d-flex align-items-center">
                        <span class="me-3"><strong>Reason:</strong> {{ reason?.tag }}</span>
                        <input type="text" class="form-control me-3" style="flex: 1" placeholder="Add your comment"
                          [(ngModel)]="reason.comment" />
                        <button class="btn btn-sm btn-danger" type="button" (click)="removeDroppedReason(i)">
                          Remove
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
              <ng-container>
                <div class="row justify-content-end mb-4">
                  <div class="col-lg-2 col-xl-2 col-md-2 col-sm-2 col-12 text-end">
                    <a (click)="saveBidStatus('save')" [class.disabled]="
                        !isBidCommentValid() &&
                        status !== 'Dropped after feasibility'
                      " class="btn btn-primary w-100">
                      Save Bid Status
                    </a>
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
        </div>

        <br />
      </div>
    </div>
  </section>

  <section>
    <div class="container-fluid">
      <div class="col-lg-12 col-xl-12 col-12 mb-3">
        <div class="card shadow-sm p-4">
          <div class="card-header bg-secondary text-white mb-3">
            <h5 class="mb-0">Interested Suppliers</h5>
          </div>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>Supplier Name</th>
                  <th>Comment</th>
                  <th>Comment Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="!projectDetails?.interestedSuppliers?.length">
                  <td colspan="4" class="text-center">No interested suppliers found</td>
                </tr>
                <tr *ngFor="let supplier of projectDetails?.interestedSuppliers">
                  <td>{{ supplier.companyName }}</td>
                  <td>
                    <div *ngIf="supplier.comment && supplier.comment.trim().length > 0">
                      <div [ngClass]="{'text-truncate': !expandedComments[supplier._id]}">
                        {{ expandedComments[supplier._id] ? supplier.comment : truncateText(supplier.comment) }}
                      </div>
                      <button *ngIf="supplier.comment.length > 100" class="btn btn-link btn-sm p-0 mt-1"
                        (click)="expandedComments[supplier._id] = !expandedComments[supplier._id]">
                        {{ expandedComments[supplier._id] ? 'View Less' : 'View More' }}
                      </button>
                    </div>
                    <div class="position-relative">
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Enter comment"
                        [(ngModel)]="supplier.comment"
                        [disabled]="supplier.attendee"
                      />
                      <button
                        *ngIf="supplier.comment"
                        class="btn btn-sm btn-danger position-absolute"
                        style="right: 5px; top: 50%; transform: translateY(-50%);"
                        (click)="deleteAttendeeComment(supplier)">
                        <i class="bi bi-trash-fill"></i>
                      </button>
                    </div>
                  </td>
                  <td>
                    <span *ngIf="supplier.attendeeUpdatedAt" class="text-muted">
                      {{ supplier.attendeeUpdatedAt | date:'dd/MM/yyyy, h:mm a' }}
                    </span>
                    <span *ngIf="!supplier.attendeeUpdatedAt" class="text-muted">
                      -
                    </span>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <span class="badge" [ngClass]="supplier.attendee ? 'bg-primary' : 'bg-warning'">
                        {{ supplier.attendee ? 'Attended' : 'Not Attending' }}
                      </span>
                      <button
                        *ngIf="supplier.attendee != true"
                        class="btn btn-sm btn-primary"
                        (click)="updateAttendee(supplier)"
                        [disabled]="!supplier.comment">
                        Attend
                      </button>
                      <button
                        class="btn btn-sm btn-danger"
                        (click)="removeInterestedSupplier(supplier)">
                        <i class="bi bi-trash-fill"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section *ngFor="let item of projectStrips">
    <div class="container-fluid">
      <div class="bg-dark py-3">
        <div class="container">
          <div class="d-flex justify-content-between align-items-center">
            <div class="container d-flex justify-content-between align-items-center">
              <p class="mb-1 text-white fw-bold">{{ item?.text }}</p>
            </div>
            <br />
            <div class="d-flex gap-2">
              <div *ngIf="item.type === 'Image'">
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                  [attr.data-bs-target]="'#imageModal_' + item._id">
                  Add
                </button>
              </div>
              <div>
                <button class="btn btn-danger btn-sm" (click)="deleteStrips(item?._id)">
                  <i class="bi bi-trash-fill"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <br />

      <div class="bg-white py-3" *ngIf="item?.type != 'Image'">
        <p class="text-secondary mb-0 fw-bold"></p>
        <p class="text-dark mb-0" [innerHTML]="item?.description"></p>
      </div>

      <div class="row align-items-center">
        <div class="col-lg-12 col-xl-12 col-12">
          <div class="d-flex flex-row flex-wrap">
            <div class="col-lg-auto col-xl-auto col-md-auto col-sm-auto col-auto me-3"
              *ngFor="let image of item?.images">
              <div class="form-group">
                <label class="display-block">{{ image?.imageText }}</label> <br />
                <div class="upload-btn-wrapper">
                  <div class="d-flex justify-content-between">
                    <a (click)="openViewImage(image)" class="btn btn-small me-2" data-bs-toggle="modal"
                      data-bs-target="#viewstripimage">
                      <i class="bi bi-eye-fill"></i> View
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" [id]="'imageModal_' + item._id" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Add Image Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <!-- Dynamic Input Fields -->
              <div *ngFor="let field of imageFields; let i = index" class="input-group mb-3">
                <input type="text" class="form-control" placeholder="Enter Text" [(ngModel)]="field.text" />
                <input type="file" class="form-control" accept="image/*" (change)="onFileChange($event, i)" />
                <button type="button" class="btn btn-danger" (click)="removeField(i)"
                  [disabled]="imageFields.length === 1">
                  Delete
                </button>
              </div>
              <button type="button" class="btn btn-secondary btn-sm mt-3" (click)="addField()">
                Add More
              </button>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" (click)="saveFields(item._id)" data-bs-dismiss="modal">
                <ngx-spinner bdColor="rgba(51,51,51,0.8)" size="small" color="#fff" type="ball-scale-multiple"
                  [fullScreen]="false"></ngx-spinner>
                Save
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- Modal to view all comments -->
<div class="modal fade" id="viewReasonList" tabindex="-1" aria-labelledby="viewReasonListLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewReasonListLabel">View All Comments</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Add new reason input field -->
        <div class="card p-3 mb-4">
          <h6 class="mb-3">Add New Reason</h6>
          <div class="d-flex gap-2">
            <input type="text" class="form-control" placeholder="Enter a new reason" [(ngModel)]="newModalReason" />
            <button class="btn btn-primary" (click)="addReasonFromModal()" [disabled]="!newModalReason.trim()">
              Add Reason
            </button>
          </div>
        </div>

        <div *ngIf="filteredComments && filteredComments.length; else noComments">
          <div *ngFor="let reason of filteredComments" class="mb-3">
            <div class="d-flex justify-content-between">
              <p class="mb-0">
                <span class="fw-bold">Comment:</span> {{ reason?.comment }}
              </p>
              <p class="mb-0 text-end">
                <span class="fw-bold">Date:</span>
                {{ reason?.date | date : "dd/MM/yyyy, h:mm a" }}
              </p>
            </div>
            <hr />
          </div>
        </div>

        <ng-template #noComments>
          <p class="text-center text-muted">No comments available.</p>
        </ng-template>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="ViewProjectLogs" tabindex="-1" aria-labelledby="ViewProjectLogsLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ViewProjectLogsLabel">Project Logs</h5>
        <div class="ms-auto me-3">
          <button type="button" class="btn btn-outline-primary me-2" [class.active]="activeLogType === 'timeBased'"
            (click)="loadLogs('timeBased')">
            Time Based
          </button>
          <button type="button" class="btn btn-outline-primary" [class.active]="activeLogType === 'projectBased'"
            (click)="loadLogs('projectBased')">
            Project Based
          </button>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body d-flex">
        <div class="flex-grow-1 pe-3">
          <div class="comments-section">
            <ul class="SecondarytaskList mt-3">
              <li *ngFor="let log of logsList" class="mb-3">
                <div class="comment-item">
                  <div class="d-flex justify-content-between">
                    <p class="mb-0" [innerHTML]="log?.log"></p>
                    <span class="text-muted">
                      {{ log?.date | date : "dd/MM/yyyy, h:mm a" }}
                    </span>
                  </div>
                </div>
              </li>
            </ul>

            <!-- No records found -->
            <p *ngIf="logsList?.length === 0" class="text-center">
              No records found
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="addClientDocument" tabindex="-1" aria-labelledby="addClientDocumentLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ViewScreenshotLabel">
          Add Client Document
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ng-container *ngIf="viewClientDocumentForm">
          <div class="card p-3 mt-3">
            <div class="row g-3 align-items-center">
              <div class="col-md-8 col-sm-12">
                <input type="text" [(ngModel)]="documentName" class="form-control" placeholder="Enter Document Name"
                  aria-label="Document Name" />
              </div>
              <div class="col-md-4 col-sm-12">
                <label class="btn btn-outline-primary w-100">
                  <i class="bi bi-file-earmark-arrow-up-fill"></i> Upload
                  <input type="file" id="uploadClientDocument" (change)="
                      uploadDocument($event, documentUploadType.clientDocument)
                    " hidden aria-label="Upload Document" />
                </label>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="addWestgateDocument" tabindex="-1" aria-labelledby="addWestgateDocumentLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ViewScreenshotLabel">
          Add Westgate Document
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ng-container *ngIf="viewClientDocumentForm">
          <div class="card p-3 mt-3">
            <div class="row g-3 align-items-center">
              <div class="col-md-8 col-sm-12">
                <input type="text" [(ngModel)]="documentName" [ngModelOptions]="{ standalone: true }"
                  class="form-control" placeholder="Enter Document Name" aria-label="Document Name" />
              </div>
              <div class="col-md-4 col-sm-12">
                <label class="btn btn-outline-primary w-100">
                  <i class="bi bi-file-earmark-arrow-up-fill"></i> Upload
                  <input type="file" id="uploadClientDocument"
                    (change)="uploadDocument($event, documentUploadType.westGetDocument)" hidden
                    aria-label="Upload Document" />
                </label>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="ViewClientDoc" tabindex="-1" aria-labelledby="ViewClientDocLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ViewClientDocLabel">
          Client Document : {{ selectedDocument?.name }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="alert alert-danger" role="alert">
         Important Notice : If you are unable to view any documents, please
        note that the files may have been uploaded as a ZIP file. Kindly
        download the ZIP file to access the documents.
      </div>
      <div class="modal-body">
        <div class="modal-body">
          <div class="modal-body">
            <ng-container *ngIf="isPdf(selectedDocument?.file?.url); else otherFormats">
              <ngx-extended-pdf-viewer [src]="selectedDocument?.file?.url" useBrowserLocale="true"
                height="600px"></ngx-extended-pdf-viewer>
            </ng-container>
            <ng-template #otherFormats>
              <iframe *ngIf="isWordOrExcel(selectedDocument?.file?.url)"
                [src]="getDocumentViewerUrl(selectedDocument?.file?.url)" style="width: 100%; height: 600px"></iframe>
              <img *ngIf="isImage(selectedDocument?.file?.url)" [src]="selectedDocument?.file?.url" class="img-fluid" />
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- View StripAdd Modal -->
<div class="modal fade" id="ViewStripAdd" tabindex="-1" aria-labelledby="ViewLogin">
  <div class="modal-dialog modal-dialog-centered" [formGroup]="addStripForm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ViewLogin">Add Strip Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- Radio Buttons to Select Upload Type -->
        <div class="form-group d-flex align-items-center mb-4">
          <label class="me-3">Select Type:</label>
          <div class="form-check me-3">
            <input type="radio" id="textOption" class="form-check-input" formControlName="type" value="Text"
              (change)="selectUploadType(true)" />
            <label for="textOption" class="form-check-label">Text</label>
          </div>
          <div class="form-check">
            <input type="radio" id="imageOption" class="form-check-input" formControlName="type" value="Image"
              (change)="selectUploadType(false)" />
            <label for="imageOption" class="form-check-label">Image</label>
          </div>
        </div>

        <!-- Conditional Rendering Based on Upload Type -->
        <div *ngIf="uploadType; else imageUploadSection">
          <!-- Text Upload Section -->
          <div class="form-group mb-3">
            <label for="textInput" class="form-label">Strip Heading :</label>
            <input type="text" id="textInput" class="form-control" placeholder="Enter Text" formControlName="text" />
            <div *ngIf="
                addStripcontrol.text.touched && addStripcontrol.text.invalid
              " class="text-danger">
              Text is required.
            </div>
          </div>

          <div class="form-group mb-3">
            <label for="textInput" class="form-label">Strip Description :</label>
            <!-- <textarea type="text" id="textInput" class="form-control" placeholder="Enter Description"
              formControlName="description"></textarea> -->

            <div class="NgxEditor__Wrapper">
              <ngx-editor-menu [editor]="editor" [toolbar]="toolbar" style="padding: 15px !important;">
              </ngx-editor-menu>
              <ngx-editor [editor]="editor" rows="5" formControlName="description" [disabled]="false"
                [placeholder]="'Type here...'"></ngx-editor>
            </div>

            <div *ngIf="
                addStripcontrol.description.touched &&
                addStripcontrol.description.invalid
              " class="text-danger">
              Description is required.
            </div>
          </div>

          <div class="form-group mb-3">
            <ng-select id="assignTo" class="form-select custom-ng-select-option" placeholder="Select Role"
              [multiple]="true" bindLabel="name" [items]="ForTitleuserList" formControlName="roles">
            </ng-select>
          </div>

        </div>

        <!-- Image Upload Section -->
        <ng-template #imageUploadSection>
          <div class="form-group mb-3">
            <label for="imageTextInput" class="form-label">Strip Heading :</label>
            <input type="text" id="imageTextInput" class="form-control" placeholder="Enter Text"
              formControlName="imageText" />
            <div *ngIf="
                addStripcontrol.imageText.touched &&
                addStripcontrol.imageText.invalid
              " class="text-danger">
              Image Text is required.
            </div>
          </div>

          <div class="form-group mb-3">
            <ng-select id="assignTo" class="form-select custom-ng-select-option" placeholder="Select Role"
              [multiple]="true" bindLabel="name" [items]="ForTitleuserList" formControlName="roles">
            </ng-select>
          </div>

        </ng-template>

        <div class="row justify-content-end mt-4">
          <div class="col-auto">
            <button (click)="addStrips()" data-bs-dismiss="modal" aria-label="Close" class="btn btn-dark">
              Add
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- View Strip image Modal -->
<div class="modal fade" id="viewstripimage" tabindex="-1" aria-labelledby="viewstripimageLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="display: flex; justify-content: space-between">
        <h5 class="modal-title" id="ViewDocumentModalLabel">
          Strip Image ({{ selectViewImage?.imageText }})
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger" role="alert" *ngIf="!selectViewImage?.url">
          Could not load image. URL is missing or invalid. Please check console for details.
        </div>

        <!-- PDF Viewer -->
        <div *ngIf="selectViewImage?.url && isPdf(selectViewImage?.url)" class="alert alert-info">
          PDF files cannot be displayed directly. <a [href]="selectViewImage?.url" target="_blank">Open PDF in new
            tab</a>
        </div>

        <!-- Office Documents -->
        <iframe *ngIf="selectViewImage?.url && isWordOrExcel(selectViewImage?.url)"
          [src]="getDocumentViewerUrl(selectViewImage?.url)" style="width: 100%; height: 600px"></iframe>

        <!-- Images - try both with and without sanitization -->
        <div *ngIf="selectViewImage?.url && isImage(selectViewImage?.url)" class="text-center">
          <img [src]="getDocumentViewerUrl(selectViewImage?.url)" class="img-fluid mb-3" alt="Sanitized Image" />
        </div>

        <!-- Fallback for non-recognized formats -->
        <div
          *ngIf="selectViewImage?.url && !isPdf(selectViewImage?.url) && !isWordOrExcel(selectViewImage?.url) && !isImage(selectViewImage?.url)"
          class="text-center">
          <div class="alert alert-warning">
            File format not recognized as PDF, Office document, or standard image. Attempting to display directly:
          </div>
          <img [src]="getDocumentViewerUrl(selectViewImage?.url)" class="img-fluid" alt="Direct Image" />
        </div>
      </div>
      <div class="modal-footer">
        <a *ngIf="selectViewImage?.url" [href]="selectViewImage?.url" target="_blank" class="btn btn-primary me-2">
          Open in New Tab
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Supplier Modal -->
<div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addSupplierModalLabel">Add Supplier Reason</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="form-group mb-3">
          <label for="supplierReason" class="form-label">Reason for Selection</label>
          <textarea class="form-control" id="supplierReason" rows="3" [(ngModel)]="supplierSelectionReason"
            placeholder="Enter reason for selecting these suppliers"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" (click)="saveSupplierSelection()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Mandatory Details Modal -->
<div class="modal fade" id="ViewMandatoryDetails" tabindex="-1" aria-labelledby="ViewMandatoryDetailsLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" [formGroup]="mandatoryDetailsForm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ViewMandatoryDetailsLabel">Mandatory Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">

        <div class="form-group mb-3">
          <label for="mandatoryDetails" class="form-label">Mandatory Details:</label>
          <div class="NgxEditor__Wrapper">
            <ngx-editor-menu [editor]="mandatoryDetailsEditor" [toolbar]="toolbar" style="padding: 15px !important;">
            </ngx-editor-menu>
            <ngx-editor [editor]="mandatoryDetailsEditor" rows="8" formControlName="details" [disabled]="false"
              [placeholder]="'Enter mandatory details here...'"></ngx-editor>
          </div>
          <div *ngIf="
              mandatoryDetailsForm.get('details')?.touched &&
              mandatoryDetailsForm.get('details')?.invalid
            " class="text-danger">
            Mandatory details are required.
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" (click)="saveMandatoryDetails()">Save</button>
      </div>
    </div>
  </div>
</div>
